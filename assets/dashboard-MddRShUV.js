import{s as u}from"./supabase-CkmPbGev.js";/* empty css              */async function x(){const{data:{session:n}}=await u.auth.getSession();return n||(window.location.href="/login.html",null)}const C=document.getElementById("income-form"),$=document.querySelector("#income-table tbody"),M=document.getElementById("filter-btn"),A=document.getElementById("filter-month-select"),F=document.getElementById("logout-btn"),T=document.getElementById("weekly-chart"),k=document.getElementById("analysis-result"),s=document.getElementById("form-msg"),d=document.getElementById("submit-income"),y=document.getElementById("income-date"),b=document.getElementById("income-amount"),E=document.getElementById("income-notes"),q=document.getElementById("current-page"),_=document.getElementById("prev-page"),S=document.getElementById("next-page"),D=document.getElementById("total-month"),B=document.getElementById("total-year");let v,l=1;const f=10;let w=0;F.addEventListener("click",async()=>{await u.auth.signOut(),window.location.href="/login.html"});y.addEventListener("change",async()=>{const n=await x();if(!n)return;const o=y.value;if(!o)return;const{data:t}=await u.from("ingresos").select("*").eq("fecha",o).limit(1).single();t?(d.textContent="Editar Ingreso",b.value=t.monto,E.value=t.notas||"",d.dataset.id=t.id,t.user_id!==n.user.id?(d.disabled=!0,s.style.color="red",s.textContent="No puedes editar un ingreso registrado por otro usuario."):(d.disabled=!1,s.textContent="")):(d.textContent="Agregar",b.value="",E.value="",d.removeAttribute("data-id"),d.disabled=!1,s.textContent="")});C.addEventListener("submit",async n=>{n.preventDefault();const o=y.value,t=parseFloat(b.value),i=E.value.trim(),r=d.dataset.id;if(s.textContent="",!o){s.textContent="Por favor selecciona una fecha.";return}if(isNaN(t)||t<=0){s.textContent="Ingrese un monto v√°lido mayor que cero.";return}const e=await x();if(e){d.disabled=!0;try{if(r){const{data:a}=await u.from("ingresos").select("*").eq("id",r).single();if(!a){s.style.color="red",s.textContent="Ingreso no encontrado.";return}if(a.user_id!==e.user.id){s.style.color="red",s.textContent="No puedes modificar un ingreso registrado por otro usuario.";return}await u.from("ingresos_historial").insert({ingreso_id:r,monto_anterior:a.monto,user_id:e.user.id}),await u.from("ingresos").update({monto:t,notas:i,modificaciones:a.modificaciones+1,updated_at:new Date().toISOString()}).eq("id",r)}else await u.from("ingresos").insert({user_id:e.user.id,fecha:o,monto:t,notas:i,modificaciones:0});s.style.color="green",s.textContent=r?"Ingreso actualizado correctamente.":"Ingreso guardado correctamente.",C.reset(),d.removeAttribute("data-id"),d.textContent="Agregar",await h(l)}catch(a){s.style.color="red",s.textContent="Error: "+a.message}finally{d.disabled=!1}}});M.addEventListener("click",()=>{l=1,h(l)});_.addEventListener("click",()=>{l>1&&(l--,h(l))});S.addEventListener("click",()=>{l*f<w&&(l++,h(l))});async function h(n=1,o=""){const t=await x();if(!t)return;const i=(n-1)*f,r=i+f-1;let e=u.from("ingresos").select("*",{count:"exact"}).order("fecha",{ascending:!1}).range(i,r);const a=o||A.value;if(a){const[c,g]=a.split("-"),p=new Date(parseInt(c),parseInt(g),0).getDate();e=e.gte("fecha",`${c}-${g}-01`).lte("fecha",`${c}-${g}-${p}`)}const{data:m,error:I,count:L}=await e;if(I){s.style.color="red",s.textContent="Error cargando ingresos: "+I.message;return}w=L||0,$.innerHTML="",m.forEach(c=>{const g=c.user_id===t.user.id,p=document.createElement("tr");p.innerHTML=`
      <td>${c.fecha}</td>
      <td>S/. ${c.monto.toFixed(2)}</td>
      <td>${c.notas||"-"}</td>
      <td>
        ${g?`<button onclick="editIngreso('${c.id}', ${c.monto}, '${c.notas||""}')" aria-label="Editar ingreso">‚úèÔ∏è</button>`:""}
        <span title="Modificaciones: ${c.modificaciones}">üìù${c.modificaciones}</span>
        <button onclick="cargarHistorial('${c.id}')" aria-label="Ver historial">üìú</button>
      </td>
    `,$.appendChild(p)}),q.textContent=`${n} de ${Math.ceil(w/f)}`,_.disabled=n===1,S.disabled=n*f>=w,N(m),H(m),P(m,a)}window.editIngreso=async(n,o,t)=>{y.value="",b.value=o,E.value=t,d.textContent="Editar Ingreso",d.dataset.id=n,s.textContent="",d.disabled=!1};window.cargarHistorial=async n=>{const{data:o,error:t}=await u.from("ingresos_historial").select("monto_anterior, fecha_modificacion, user_id").eq("ingreso_id",n).order("fecha_modificacion",{ascending:!1});if(t){alert("Error cargando historial: "+t.message);return}const i=document.createElement("div");i.className="historial-modal",i.innerHTML=`
    <h3>Historial de Modificaciones</h3>
    <ul>
      ${o.length?o.map(r=>`
        <li>
          ${new Date(r.fecha_modificacion).toLocaleString()}: S/. ${r.monto_anterior.toFixed(2)} (Usuario: ${r.user_id})
        </li>
      `).join(""):"<li>No hay modificaciones.</li>"}
    </ul>
    <button onclick="this.parentElement.remove()">Cerrar</button>
  `,document.body.appendChild(i)};function N(n){const o=new Date,t=new Date(o.getFullYear(),o.getMonth()+1,0).getDate(),i=Array(t).fill(0);n.forEach(r=>{const e=new Date(r.fecha).getDate()-1;i[e]+=r.monto}),v&&v.destroy(),v=new Chart(T,{type:"bar",data:{labels:Array.from({length:t},(r,e)=>e+1),datasets:[{label:"Ingresos por d√≠a",data:i,backgroundColor:"#bc6c25",borderColor:"#99582a",borderWidth:1}]},options:{responsive:!0,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Monto (S/.)"}},x:{title:{display:!0,text:"D√≠a del mes"}}}}})}function H(n){const o=Array(7).fill(0);n.forEach(e=>{const a=new Date(e.fecha).getDay();o[a]+=e.monto});const t=["domingo","lunes","martes","mi√©rcoles","jueves","viernes","s√°bado"],r=o.map((e,a)=>({day:t[a],total:e})).sort((e,a)=>a.total-e.total).slice(0,3).map(({day:e,total:a},m)=>`${m+1}¬∫: ${e} (S/. ${a.toFixed(2)})`).join(", ");k.textContent=`üìä Los 3 d√≠as con mayores ingresos son: ${r}.`}function P(n,o){const t=new Date().getFullYear();let i=0,r=0;n.forEach(({monto:e,fecha:a})=>{const m=new Date(a);(!o||a.startsWith(o))&&(i+=e),m.getFullYear()===t&&(r+=e)}),D&&(D.textContent=`Total mes: S/. ${i.toFixed(2)}`),B&&(B.textContent=`Total a√±o ${t}: S/. ${r.toFixed(2)}`)}window.addEventListener("DOMContentLoaded",()=>{y.value=new Date().toISOString().split("T")[0],h(l)});
